name: Peggy Auto-Fix

on:
  issues:
    types: [labeled]

jobs:
  claude:
    if: github.event.label.name == 'peggy-fix'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 25
            --allowedTools "Bash(npm test),Bash(npm run *),Read,Write,Edit,Glob,Grep"
          prompt: |
            You are fixing a bug in the NeverendingStory API server (Node.js/Express).

            READ THE ISSUE BODY FOR YOUR INSTRUCTIONS. It contains:
            - BUG REPORT SUMMARY
            - AI DIAGNOSIS
            - SUGGESTED FIX
            - FILES LIKELY INVOLVED

            RULES:
            1. Read the diagnosis and suggested fix carefully
            2. Look at the files mentioned in "FILES LIKELY INVOLVED"
            3. Implement the fix
            4. Run `npm test` and make sure ALL tests pass
            5. If your fix breaks tests, fix the tests too (unless the test was genuinely wrong)
            6. If you can't figure out the fix, create the PR anyway with what you tried and a note about what's blocking you

            IMPORTANT:
            - This is a SERVER-SIDE Node.js codebase
            - Do NOT touch any Swift/iOS files
            - The API runs on Express with routes in src/routes/
            - Database is Supabase PostgreSQL via @supabase/supabase-js
            - Do NOT modify test infrastructure unless a test is genuinely wrong
            - Keep changes minimal â€” fix the bug, don't refactor the world
